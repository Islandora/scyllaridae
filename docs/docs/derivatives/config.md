## Drupal Actions/Context

Next, you need to define an action and context on when to execute your derivative

You'll want to read the Islandora docs around this: https://islandora.github.io/documentation/concepts/derivatives/

I typically try to find an existing action at `/admin/config/system/actions` to create the new action. I don't have great guidance around this as this setup seems a little less flexible than might be desired, but it typically only takes about five minutes to figure out the correct on. We should probably do a bit of work in the islandora drupal module to make this easier.

But the import thing is you'll want to remember what you set for the queue name (you'll want to create a new queue name). You'll need that value later on when configuring alpaca
To deploy your microservice, you need to have the service running in your docker compose deployment and make sure alpaca is aware of the service.

## docker-compose

Add the microservice to your docker compose, being sure to replace `YOUR-MICROSERVICE` with your actual microservce name

```
    YOUR-MICROSERVICE-dev: &YOUR-MICROSERVICE
        <<: [*dev, *common]
        image: lehighlts/scyllaridae-YOUR-MICROSERVICE:main
        environment:
            JWKS_URI: https://${DOMAIN}/oauth/discovery/keys
        volumes:
          # un-comment one of the volumes below, depending on your ISLE deployment repo
          # to add the ISLE CA to scyllaridae's trust store
          # 
          # isle-site-template
          # - ./certs/rootCA.pem:/app/ca.pem
          # isle-dc
          # - ../../certs/rootCA.pem:/app/ca.pem
        networks:
            default:
                aliases:
                    - YOUR-MICROSERVICE
    YOUR-MICROSERVICE-prod:
        <<: [*prod, *YOUR-MICROSERVICE]
```

### islandora_jwks
Notice the `JWKS_URI` environment variable in the deployment. This locks down your microservice to require a JWT token generated by Islandora when generating the derivative. The JWKS URI is made available by installing the `drupal/islandora_jwks` module: https://www.drupal.org/project/islandora_jwks

You could disable this by setting an env var `SKIP_JWT_VERIFY=true` instead.

### Using local CA for development

Scyllaridae verifies TLS connections, for example when it tries to fetch the source file from Islandora to perform a conversion.  In development (for example when using the `islandora.dev` domain), this verification can fail because the islandora.dev certificate is issued by a local CA which is not known/trusted.

The symptom is that conversion will fail, and your scyllaridae microservice will show an entry like this in the logs

```
    scyllaridae-1  | 2025/07/02 16:34:30 ERROR Unable to get source URI uri=https://islandora.dev/_flysystem/fedora/2025-07/your-document.docx err="Head \"https://islandora.dev/_flysystem/fedora/2025-07/your-document.docx\": tls: failed to verify certificate: x509: certificate signed by unknown authority"
```

You can resolve this issue by mapping your local CA into the scyllaridae container at the path /app/ca.pem. 

If you are using a dev domain managed using isle-site-template, your CA file should already be in `certs/rootCA.pem`

If you are using a dev domain managed using isle-dc, you can run `mkcert -CAROOT` to determine the location of your local CA files.  Copy the `rootCA.pem` file into your `isle-dc/certs directory`. 

After you've located your `rootCA.pem` file on your host system, bind mount that file in the volumes section of your scyllaridae service(s) to`/app/ca.pem`.

## Configure alpaca

You'll also need to add `YOUR-MICROSERVICE` to `derivative.systems.installed` in your `alpaca.properties` by adding that string to the `ALPACA_DERIVATIVE_SYSTEMS` environment variable in your alpaca service, being sure to replace `YOUR-MICROSERVICE` with your actual microservce name

```
ALPACA_DERIVATIVE_SYSTEMS=YOUR-MICROSERVICE
```

### override alpaca properties

You'll also need to define the service in alpaca.properties.tmpl. If running docker, and you haven't already overwritten the alpaca conf,g you'll want to grab the default value for `alpaca.properties.tmpl` from https://github.com/Islandora-Devops/isle-buildkit/blob/main/alpaca/rootfs/etc/confd/templates/alpaca.properties.tmpl and put that in your docker compose directory, and mount the file in your alpaca service using a volume mount

```
    alpaca-prod: &alpaca-prod
        <<: [*prod, *alpaca]
        image: ${ISLANDORA_REPOSITORY}/alpaca:${ISLANDORA_TAG}
        volumes:
            - ./conf/alpaca/alpaca.properties.tmpl:/etc/confd/templates/alpaca.properties.tmpl:r
```

### add your microservice to the queue

Now that you're overriding alpaca properties, you can add this to the bottom of alpaca.properties.tmpl, being sure to replace `islandora-connector-YOUR-MICROSERVICE` with your queue name from your Drupal action and `YOUR-MICROSERVICE` with your actual microservce

```
derivative.YOUR-MICROSERVICE.enabled=true
derivative.YOUR-MICROSERVICE.in.stream=queue:islandora-connector-YOUR-MICROSERVICE
# this url may be different if deploying via kubernetes
derivative.YOUR-MICROSERVICE.service.url=http://YOUR-MICROSERVICE:8080
derivative.YOUR-MICROSERVICE.concurrent-consumers=1
derivative.YOUR-MICROSERVICE.max-concurrent-consumers=-1
derivative.YOUR-MICROSERVICE.async-consumer=true
```
